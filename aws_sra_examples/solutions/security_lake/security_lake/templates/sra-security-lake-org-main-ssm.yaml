########################################################################
# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: MIT-0
########################################################################
AWSTemplateFormatVersion: 2010-09-09
Description:
  This template creates a custom resource Lambda to delegate administration and configure SecurityLake within an AWS Organization - 'security_lake_org'
  solution in the repo, https://github.com/aws-samples/aws-security-reference-architecture-examples (sra-1ssgnse80)

Metadata:
  SRA:
    Version: 1.0
    Entry: Parameters for deploying the solution resolving SSM parameters
    Order: 1
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: General Properties
        Parameters:
          - pSRASolutionName
          - pSRASolutionVersion
          - pSRAStagingS3BucketName
          - pSRAAlarmEmail
          - pAuditAccountId
          - pLogArchiveAccountId
          - pRootOrganizationalUnitId
          - pStackSetAdminRole
          - pStackExecutionRole
          - pOrganizationId

      - Label:
          default: Security Lake Configuration - Properties
        Parameters:
          - pControlTowerRegionsOnly
          - pEnabledRegions
          # - pCreateKmsKey
          - pSecurityLakeWarning

      - Label:
          default: Security Lake Configuration - Sources to Ingest
        Parameters:
          # - pSources
          - pSourceVersion
          - pCloudTrailManagementEvents
          - pCloudTrailLambdaDataEvents
          - pCloudTrailS3DataEvents
          - pSecurityHubFindings
          - pVpcFlowLogs
          - pWafLogs
          - pRoute53Logs
          - pEksAuditLogs

      - Label:
          default: Security Lake Configuration - Organization Configurations
        Parameters:
          - pCreateOrganizationConfiguration
          - pOrgConfigurationSources

      - Label:
          default: Security Lake Configuration - Audit Account Subscribers
        Parameters:
          - pRegisterAuditAccountDataSubscriber
          - pRegisterAuditAccountQuerySubscriber
      
      - Label:
          default: Security Lake Configuration - Query Access Subscriber
        Parameters:
          - pCreateQuerySubscriber
          - pQuerySubscriberName
          - pQuerySubscriberExternalId
          - pQuerySubscriberRegions
          - pQuerySubscriberLogSources
          - pQuerySubscriberAccount
      
      - Label:
          default: Security Lake Configuration - Data Access Subscriber
        Parameters:
          - pCreateDataSubscriber
          - pDataSubscriberName
          - pDataSubscriberExternalId
          - pDataSubscriberRegions
          - pDataSubscriberLogSources
          - pDataSubscriberAccount
          - pCreateDataSubscriberNotification

      - Label:
          default: General Lambda Function Properties
        Parameters:
          - pCreateLambdaLogGroup
          - pLambdaLogGroupRetention
          - pLambdaLogGroupKmsKey
          - pLambdaLogLevel

      - Label:
          default: EventBridge Rule Properties
        Parameters:
          - pControlTowerLifeCycleRuleName
          - pComplianceFrequency

    ParameterLabels:
      pCloudTrailManagementEvents:
        default: CloudTrail - Management Events
      pLogArchiveAccountId:
        default: Log Archive Account ID
      pCloudTrailLambdaDataEvents:
        default: CloudTrail - Lambda Data Events
      pCloudTrailS3DataEvents:
        default: CloudTrail - S3 Data Events
      pSecurityHubFindings:
        default: SecurityHub Findings
      pVpcFlowLogs:
        default: VPC Flow Logs
      pWafLogs:
        default: WAFv2 Logs
      pRoute53Logs:
        default: Amazon Route 53 Resolver Query Logs
      pEksAuditLogs:
        default: Amazon EKS Audit Logs
      # pSources:
      #   default: Sources
      pOrgConfigurationSources:
        default: Sources for Organizaiton Configuration
      pCreateOrganizationConfiguration:
        default: Create Organization Configuration
      pSourceVersion:
        default: Log Source Version
      pSecurityLakeConfigurationRoleName:
        default: Security Lake Configuration Role Name
      # pCreateKmsKey:
      #   default: Create KMS Key
      pAuditAccountId:
        default: Audit Account ID
      pComplianceFrequency:
        default: Frequency to Check for Organizational Compliance
      pControlTowerLifeCycleRuleName:
        default: Control Tower Lifecycle Rule Name
      pControlTowerRegionsOnly:
        default: Governed Regions Only
      pCreateLambdaLogGroup:
        default: Create Lambda Log Group
      pEnabledRegions:
        default: (Optional) Enabled Regions
      pLambdaLogGroupKmsKey:
        default: (Optional) Lambda Logs KMS Key
      pLambdaLogGroupRetention:
        default: Lambda Log Group Retention
      pLambdaLogLevel:
        default: Lambda Log Level
      pRootOrganizationalUnitId:
        default: Root Organizational Unit ID
      pSRAAlarmEmail:
        default: (Optional) SRA Alarm Email
      pSRASolutionName:
        default: SRA Solution Name
      pSRASolutionVersion:
        default: SRA Solution Version
      pSRAStagingS3BucketName:
        default: SRA Staging S3 Bucket Name

      pRegisterAuditAccountDataSubscriber:
        default: Register Audit Account as a Subscriber with Data Access
      pRegisterAuditAccountQuerySubscriber:
        default: Register Audit Account as a Subscriber with Query Access
      pCreateQuerySubscriber:
        default: Register a query access subscriber
      pCreateDataSubscriber:
        default: Register a data access subscriber
      pQuerySubscriberName:
        default: Query access subscriber name
      pDataSubscriberName:
        default: Data access subscriber name
      pQuerySubscriberExternalId:
        default: Query access subscriber external id
      pDataSubscriberExternalId:
        default: Data access subscriber external id
      pQuerySubscriberRegions:
        default: Query access subscriber regions
      pDataSubscriberRegions:
        default: Data access subscriber regions
      pQuerySubscriberLogSources:
        default: Query access subscriber log sources
      pDataSubscriberLogSources:
        default: Data access subscriber log sources
      pQuerySubscriberAccount:
        default: Query access subscriber account id
      pDataSubscriberAccount:
        default: Data access subscriber account id
      pCreateDataSubscriberNotification:
        default: Create Subscriber Notification
      pStackSetAdminRole:
        default: Stack Set Role
      pStackExecutionRole:
        default: Stack execution role
      pOrganizationId:
        default: Organization ID
      pSecurityLakeWarning:
        default: Security Lake Warning

Parameters:
  pSourceVersion:
    AllowedValues: [2.0]
    ConstraintDescription: Must be a valid version number. Currently supported version is 2.0
    Description: 'Chose the version of data source from which you want to ingest log and event sources'
    Default: 2.0
    Type: String
  pCloudTrailManagementEvents:
    AllowedPattern: '^($|ALL|(\d{12})(,\s*\d{12})*)$'
    ConstraintDescription: 'Enter "ALL" or a comma-separated list of AWS account numbers without spaces, e.g., "123456789012,234567890123" to create log source. Leave empty to skip log source creation'
    Description:
      Accounts to ingest CloudTrail - Management events from. Choose ALL to enable for all accounts in your AWS Organization. To choose the accounts enter a comma
      seperated list of the AWS Account numbers.  Leave empty to skip log source creation.
    Type: CommaDelimitedList
    Default: 'ALL'
  pCloudTrailLambdaDataEvents:
    AllowedPattern: '^($|ALL|(\d{12})(,\s*\d{12})*)$'
    ConstraintDescription: 'Enter "ALL" or a comma-separated list of AWS account numbers without spaces, e.g., "123456789012,234567890123" to create log source. Leave empty to skip log source creation'
    Description:
      Accounts to ingest CloudTrail - Lambda Data events from. Choose ALL to enable for all accounts in your AWS Organization. To choose the accounts enter a comma
      seperated list of the AWS Account numbers.  Leave empty to skip log source creation.
    Type: CommaDelimitedList
    Default: 'ALL'
  pCloudTrailS3DataEvents:
    AllowedPattern: '^($|ALL|(\d{12})(,\s*\d{12})*)$'
    ConstraintDescription: 'Enter "ALL" or a comma-separated list of AWS account numbers without spaces, e.g., "123456789012,234567890123" to create log source. Leave empty to skip log source creation'
    Description:
      Accounts to ingest CloudTrail - S3 Data events from. Choose ALL to enable for all accounts in your AWS Organization. To choose the accounts enter a comma
      seperated list of the AWS Account numbers.  Leave empty to skip log source creation.
    Type: CommaDelimitedList
    Default: ''
  pSecurityHubFindings:
    AllowedPattern: '^($|ALL|(\d{12})(,\s*\d{12})*)$'
    ConstraintDescription: 'Enter "ALL" or a comma-separated list of AWS account numbers without spaces, e.g., "123456789012,234567890123" to create log source. Leave empty to skip log source creation'
    Description:
      Accounts to ingest SecurityHub Findings from. Choose ALL to enable for all accounts in your AWS Organization. To choose the accounts enter a comma
      seperated list of the AWS Account numbers.  Leave empty to skip log source creation.
    Type: CommaDelimitedList
    Default: 'ALL'
  pVpcFlowLogs:
    AllowedPattern: '^($|ALL|(\d{12})(,\s*\d{12})*)$'
    ConstraintDescription: 'Enter "ALL" or a comma-separated list of AWS account numbers without spaces, e.g., "123456789012,234567890123" to create log source. Leave empty to skip log source creation'
    Description:
      Accounts to ingest VPC Flow Logs from. Choose ALL to enable for all accounts in your AWS Organization. To choose the accounts enter a comma
      seperated list of the AWS Account numbers.  Leave empty to skip log source creation.
    Type: CommaDelimitedList
    Default: 'ALL'
  pWafLogs:
    AllowedPattern: '^($|ALL|(\d{12})(,\s*\d{12})*)$'
    ConstraintDescription: 'Enter "ALL" or a comma-separated list of AWS account numbers without spaces, e.g., "123456789012,234567890123" to create log source. Leave empty to skip log source creation'
    Description:
      Accounts to ingest WAFv2 Logs from. Choose ALL to enable for all accounts in your AWS Organization. To choose the accounts enter a comma
      seperated list of the AWS Account numbers.  Leave empty to skip log source creation.
    Type: CommaDelimitedList
    Default: ''
  pRoute53Logs:
    AllowedPattern: '^($|ALL|(\d{12})(,\s*\d{12})*)$'
    ConstraintDescription: 'Enter "ALL" or a comma-separated list of AWS account numbers without spaces, e.g., "123456789012,234567890123" to create log source. Leave empty to skip log source creation'
    Description:
      Accounts to ingest Amazon Route 53 resolver query logs from. Choose ALL to enable for all accounts in your AWS Organization. To choose the accounts enter a comma
      seperated list of the AWS Account numbers.  Leave empty to skip log source creation.
    Type: CommaDelimitedList
    Default: 'ALL'
  pEksAuditLogs:
    AllowedPattern: '^($|ALL|(\d{12})(,\s*\d{12})*)$'
    ConstraintDescription: 'Enter "ALL" or a comma-separated list of AWS account numbers without spaces, e.g., "123456789012,234567890123" to create log source. Leave empty to skip log source creation'
    Description:
      Accounts to injest Amazon EKS Audit Logs from. Choose ALL to enable for all accounts in your AWS Organization. To choose the accounts enter a comma
      seperated list of the AWS Account numbers.  Leave empty to skip log source creation.
    Type: CommaDelimitedList
    Default: 'ALL'
  pLogArchiveAccountId:
    AllowedPattern: '^([\w.-]{1,900})$|^(\/[\w.-]{1,900})*[\w.-]{1,900}$'
    ConstraintDescription:
      Must be alphanumeric or special characters [., _, -]. In addition, the slash character ( / ) used to delineate hierarchies in parameter names.
    Default: /sra/control-tower/log-archive-account-id
    Description: SSM Parameter for AWS Account ID of the Log Archive account.
    Type: AWS::SSM::Parameter::Value<String>
  # pSources:
  #   AllowedValues: ['', ROUTE53, VPC_FLOW, SH_FINDINGS, CLOUD_TRAIL_MGMT, LAMBDA_EXECUTION, S3_DATA, EKS_AUDIT, WAF]
  #   Default: ROUTE53, VPC_FLOW, SH_FINDINGS, CLOUD_TRAIL_MGMT, LAMBDA_EXECUTION, S3_DATA, EKS_AUDIT, WAF
  #   Description: AWS log sources to ingest in all accounts
  #   Type: CommaDelimitedList
  pOrgConfigurationSources:
    AllowedValues: ['', ROUTE53, VPC_FLOW, SH_FINDINGS, CLOUD_TRAIL_MGMT, LAMBDA_EXECUTION, S3_DATA, EKS_AUDIT, WAF]
    Default: ROUTE53, VPC_FLOW, SH_FINDINGS, CLOUD_TRAIL_MGMT, LAMBDA_EXECUTION, S3_DATA, EKS_AUDIT, WAF
    Description: (Optional) AWS log sources to enable for new member accounts in your organization. If 'Create Organization Configuration' parameter is set to 'true', then this parameter becomes required.
    Type: CommaDelimitedList
  pCreateOrganizationConfiguration:
    AllowedValues: ['true', 'false']
    Default: 'true'
    Description: Select whether to automatically enable Amazon Security Lake for new member accounts in your organization
    Type: String
  # pCreateKmsKey:
  #   AllowedValues: [true, false]
  #   Default: true
  #   Description: (Optional) Create KMS Key to use for encrypting Security Lake S3 resources.  If set to 'false', files will be encrypted using S3 Managed key.
  #   Type: String
  pAuditAccountId:
    AllowedPattern: '^([\w.-]{1,900})$|^(\/[\w.-]{1,900})*[\w.-]{1,900}$'
    ConstraintDescription:
      Must be alphanumeric or special characters [., _, -]. In addition, the slash character ( / ) used to delineate hierarchies in parameter names.
    Default: /sra/control-tower/audit-account-id
    Description: SSM Parameter for AWS Account ID of the Control Tower account to delegate administration.
    Type: AWS::SSM::Parameter::Value<String>
  pComplianceFrequency:
    ConstraintDescription: Compliance Frequency must be a number between 1 and 30, inclusive.
    Default: 7
    Description: Frequency (in days between 1 and 30, default is 7) to check organizational compliance by invoking the Lambda Function.
    MinValue: 1
    MaxValue: 30
    Type: Number
  pControlTowerLifeCycleRuleName:
    AllowedPattern: '^[\w.-]{1,64}$'
    ConstraintDescription: Max 64 alphanumeric and underscore characters. Also special characters supported [., -]
    Default: sra-security-lake-org-trigger
    Description: The name of the AWS Control Tower Life Cycle Rule.
    Type: String
  pControlTowerRegionsOnly:
    AllowedValues: ['true', 'false']
    Default: 'false'
    Description:  Only enable in the customer governed regions specified in Control Tower or Common Prerequisites solution
    Type: String
  pCreateLambdaLogGroup:
    AllowedValues: ['true', 'false']
    Default: 'false'
    Description:
      Indicates whether a CloudWatch Log Group should be explicitly created for the Lambda function, to allow for setting a Log Retention and/or KMS
      Key for encryption.
    Type: String
  pEnabledRegions:
    AllowedPattern: '^$|^([a-z0-9-]{1,64})$|^(([a-z0-9-]{1,64},)*[a-z0-9-]{1,64})$'
    ConstraintDescription:
      Only lowercase letters, numbers, and hyphens ('-') allowed. (e.g. us-east-1) Additional AWS regions can be provided, separated by commas. (e.g.
      us-east-1,ap-southeast-2)
    Default: ''
    Description: (Optional) Enabled regions (AWS regions, separated by commas). Leave blank to enable all regions.
    Type: String
  pLambdaLogGroupKmsKey:
    AllowedPattern: '^$|^arn:(aws[a-zA-Z-]*){1}:kms:[a-z0-9-]+:\d{12}:key\/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$'
    ConstraintDescription: 'Key ARN example:  arn:aws:kms:us-east-2:111122223333:key/1234abcd-12ab-34cd-56ef-1234567890ab'
    Default: ''
    Description:
      (Optional) KMS Key ARN to use for encrypting the Lambda logs data. If empty, encryption is enabled with CloudWatch Logs managing the server-side
      encryption keys.
    Type: String
  pLambdaLogGroupRetention:
    AllowedValues: [1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653]
    Default: 14
    Description: Specifies the number of days you want to retain log events
    Type: String
  pLambdaLogLevel:
    AllowedValues: [INFO, ERROR, DEBUG]
    Default: INFO
    Description: Lambda Function Logging Level
    Type: String
  pRootOrganizationalUnitId:
    AllowedPattern: '^([\w.-]{1,900})$|^(\/[\w.-]{1,900})*[\w.-]{1,900}$'
    ConstraintDescription:
      Must be alphanumeric or special characters [., _, -]. In addition, the slash character ( / ) used to delineate hierarchies in parameter names.
    Default: /sra/control-tower/root-organizational-unit-id
    Description: SSM Parameter for Root Organizational Unit ID
    Type: AWS::SSM::Parameter::Value<String>
  pSRAAlarmEmail:
    AllowedPattern: '^$|^([a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+)$'
    ConstraintDescription: Must be a valid email address.
    Default: ''
    Description: (Optional) Email address for receiving SRA alarms
    Type: String
  pSRASolutionName:
    AllowedValues: [sra-security-lake]
    Default: sra-security-lake
    Description: The SRA solution name. The default value is the folder name of the solution
    Type: String
  pSRAStagingS3BucketName:
    AllowedPattern: '^([\w.-]{1,900})$|^(\/[\w.-]{1,900})*[\w.-]{1,900}$'
    ConstraintDescription:
      Must be alphanumeric or special characters [., _, -]. In addition, the slash character ( / ) used to delineate hierarchies in parameter names.
    Default: /sra/staging-s3-bucket-name
    Description:
      SSM Parameter for SRA Staging S3 bucket name for the artifacts relevant to solution. (e.g., lambda zips, CloudFormation templates) S3 bucket
      name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Type: AWS::SSM::Parameter::Value<String>
  pSRASolutionVersion:
    AllowedValues: [v1.0]
    Default: v1.0
    Description: The SRA solution version. Used to trigger updates on the nested StackSets.
    Type: String
  
  pRegisterAuditAccountDataSubscriber:
    AllowedValues: ['true', 'false']
    Default: 'true'
    Description: Identifies whether to register Audit Account as a Subscriber with Data Access
    Type: String
  pRegisterAuditAccountQuerySubscriber:
    AllowedValues: ['true', 'false']
    Default: 'true'
    Description: Identifies whether to register Audit Account as a Subscriber with Query Access
    Type: String
  pCreateQuerySubscriber:
    AllowedValues: ['true', 'false']
    Default: 'false'
    Description: Identifies whether to register a new query access Subscriber
    Type: String
  pCreateDataSubscriber:
    AllowedValues: ['true', 'false']
    Default: 'false'
    Description: Identifies whether to register a new data access Subscriber
    Type: String  
  pQuerySubscriberName:
    AllowedPattern: '^$|^[a-zA-Z][-a-zA-Z0-9]*$'
    ConstraintDescription: Subscriber name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Default: ''
    Description: (Optional) Name for Security Lake subscriber with query access. If 'Register a query access subscriber' parameter is set to 'true', then this parameter becomes required.
    Type: String
  pDataSubscriberName:
    AllowedPattern: '^$|^[a-zA-Z][-a-zA-Z0-9]*$'
    ConstraintDescription: Subscriber name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Default: ''
    Description: (Optional) Name for Security Lake subscriber with data access. If 'Register a data access subscriber' parameter is set to 'true', then this parameter becomes required.
    Type: String
  pQuerySubscriberExternalId:
    AllowedPattern: '^$|^[a-zA-Z0-9-]{1,64}$'
    ConstraintDescription: Max 64 alphanumeric and underscore characters. Also special characters supported [., -]
    Default: ''
    Description: (Optional) External ID for Security Lake query access subscriber. If 'Register a query access subscriber' parameter is set to 'true', then this parameter becomes required.
    Type: String
  pDataSubscriberExternalId:
    AllowedPattern: '^$|^[a-zA-Z0-9-]{1,64}$'
    ConstraintDescription: Max 64 alphanumeric and underscore characters. Also special characters supported [., -]
    Default: ''
    Description: (Optional) External ID for Security Lake data access subscriber. If 'Register a data access subscriber' parameter is set to 'true', then this parameter becomes required.
    Type: String
  pQuerySubscriberRegions:
    AllowedPattern: '^$|^([a-z0-9-]{1,64})$|^(([a-z0-9-]{1,64},)*[a-z0-9-]{1,64})$'
    ConstraintDescription:
      Only lowercase letters, numbers, and hyphens ('-') allowed. (e.g. us-east-1) Additional AWS regions can be provided, separated by commas. (e.g.
      us-east-1,ap-southeast-2)
    Default: ''
    Description: (Optional) Query access subscriber regions (AWS regions, separated by commas). Leave blank to enable all regions.
    Type: String
  pDataSubscriberRegions:
    AllowedPattern: '^$|^([a-z0-9-]{1,64})$|^(([a-z0-9-]{1,64},)*[a-z0-9-]{1,64})$'
    ConstraintDescription:
      Only lowercase letters, numbers, and hyphens ('-') allowed. (e.g. us-east-1) Additional AWS regions can be provided, separated by commas. (e.g.
      us-east-1,ap-southeast-2)
    Default: ''
    Description: (Optional) Data access subscriber regions (AWS regions, separated by commas). Leave blank to enable all regions.
    Type: String
  pQuerySubscriberLogSources:
    AllowedValues: [ROUTE53, VPC_FLOW, SH_FINDINGS, CLOUD_TRAIL_MGMT, LAMBDA_EXECUTION, S3_DATA, EKS_AUDIT, WAF]
    Default: ROUTE53, VPC_FLOW, SH_FINDINGS, CLOUD_TRAIL_MGMT, LAMBDA_EXECUTION, S3_DATA, EKS_AUDIT, WAF
    Description: (Optional) Log sources query subscriber can access. If 'Register a query access subscriber' parameter is set to 'true', then this parameter becomes required.
    Type: CommaDelimitedList
  pDataSubscriberLogSources:
    AllowedValues: [ROUTE53, VPC_FLOW, SH_FINDINGS, CLOUD_TRAIL_MGMT, LAMBDA_EXECUTION, S3_DATA, EKS_AUDIT, WAF]
    Default: ROUTE53, VPC_FLOW, SH_FINDINGS, CLOUD_TRAIL_MGMT, LAMBDA_EXECUTION, S3_DATA, EKS_AUDIT, WAF
    Description: (Optional) Log sources data access subscriber can access. If 'Register a data access subscriber' parameter is set to 'true', then this parameter becomes required.
    Type: CommaDelimitedList
  pQuerySubscriberAccount:
    AllowedPattern: '^\d{12}$'
    Default: 222222222222
    ConstraintDescription: Must be 12 digits.
    Description: (Optional) AWS Account ID of the query access subscriber. If 'Register a query access subscriber' parameter is set to 'true', then this parameter becomes required.
    Type: String
  pDataSubscriberAccount:
    AllowedPattern: '^\d{12}$'
    Default: 222222222222
    ConstraintDescription: Must be 12 digits.
    Description: (Optional) AWS Account ID of the data access subscriber. If 'Register a data access subscriber' parameter is set to 'true', then this parameter becomes required.
    Type: String
  pCreateDataSubscriberNotification:
    AllowedValues: ['ignore', 'SQS']
    Default: 'ignore'
    Description: (Optional) Choose 'SQS' to create a new Subscriber Notification. Choose 'ignore' to skip Subscriber Notification creation.
    Type: String
  pStackSetAdminRole:
    AllowedValues: [sra-stackset]
    Default: sra-stackset
    Description: The administration role name that is used in the stackset.
    Type: String
  pStackExecutionRole:
    AllowedValues: [sra-execution]
    Default: sra-execution
    Description: The execution role name that is used in the stack.
    Type: String
  pOrganizationId:
    AllowedPattern: '^([\w.-]{1,900})$|^(\/[\w.-]{1,900})*[\w.-]{1,900}$'
    ConstraintDescription:
      Must be alphanumeric or special characters [., _, -]. In addition, the slash character ( / ) used to delineate hierarchies in parameter names.
    Default: /sra/control-tower/organization-id
    Description: SSM Parameter for AWS Organizations ID
    Type: AWS::SSM::Parameter::Value<String>
  pSecurityLakeWarning:
    AllowedValues: ['Accept', 'Reject']
    Default: 'Reject'
    Description:
      (Disclaimer) In supported Regions, new Security Lake account holders can try the service free for 15 days. Costs would be incurred after the free trial period. For details see https://aws.amazon.com/security-lake/pricing/
    Type: String

Conditions:
  cRegisterAuditAccountQuerySubscriber: !Equals [!Ref pRegisterAuditAccountQuerySubscriber, 'true']
  cCreateQuerySubscriber: !Equals [!Ref pCreateQuerySubscriber, 'true']
  cCreateSubscriberRole: !Or
    - !Condition cCreateQuerySubscriber
    - !Condition cRegisterAuditAccountQuerySubscriber

Rules:
  VerifySecurityLakeDisclaimer:
    RuleCondition: !Equals [!Ref pSecurityLakeWarning, 'Reject']
    Assertions:
      - Assert: !Not [!Equals [!Ref pSecurityLakeWarning, 'Reject']]
        AssertDescription: 'Please Acknowledge Security Lake pricing disclaimer'

Resources:
  rSecurityLakeQuerySubscriberIAMRoleStackSet:
    Type: AWS::CloudFormation::StackSet
    Condition: cCreateSubscriberRole
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      StackSetName: sra-security-lake-query-subscriber-role
      AdministrationRoleARN: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/${pStackSetAdminRole}
      CallAs: SELF
      Capabilities:
        - CAPABILITY_NAMED_IAM
      Description:
        !Sub ${pSRASolutionVersion} - Deploys an IAM role via ${pSRASolutionName} for configuring SecurityLake Subscriber account
      ExecutionRoleName: !Ref pStackExecutionRole
      ManagedExecution:
        Active: true
      OperationPreferences:
        FailureTolerancePercentage: 0
        MaxConcurrentPercentage: 100
        RegionConcurrencyType: PARALLEL
      PermissionModel: SELF_MANAGED
      StackInstancesGroup:
        - DeploymentTargets:
            Accounts:  # TODO separate into two stacks
              - !If
                - cCreateQuerySubscriber
                - !Ref pQuerySubscriberAccount
                - !Ref 'AWS::NoValue'
              - !If
                - cRegisterAuditAccountQuerySubscriber
                - !Ref pAuditAccountId
                - !Ref 'AWS::NoValue'
          Regions:
            - !Ref AWS::Region
      TemplateURL: !Sub https://${pSRAStagingS3BucketName}.s3.${AWS::Region}.${AWS::URLSuffix}/${pSRASolutionName}/templates/sra-security-lake-query-subscriber-role.yaml
      Parameters:
        - ParameterKey: pManagementAccountId
          ParameterValue: !Ref AWS::AccountId
      Tags:
        - Key: sra-solution
          Value: !Ref pSRASolutionName

  rSecurityLakeConfigurationIAMRoleStackSet:
    Type: AWS::CloudFormation::StackSet
    DeletionPolicy: Delete
    UpdateReplacePolicy: Retain
    Properties:
      StackSetName: sra-security-lake-org-configuration-role
      AdministrationRoleARN: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/${pStackSetAdminRole}
      CallAs: SELF
      Capabilities:
        - CAPABILITY_NAMED_IAM
      Description: !Sub ${pSRASolutionVersion} - Deploys an IAM role via ${pSRASolutionName} for configuring SecurityLake
      ExecutionRoleName: !Ref pStackExecutionRole
      ManagedExecution:
        Active: true
      OperationPreferences:
        FailureTolerancePercentage: 0
        MaxConcurrentPercentage: 100
        RegionConcurrencyType: PARALLEL
      PermissionModel: SELF_MANAGED
      StackInstancesGroup:
        - DeploymentTargets:
            Accounts:
              - !Ref pLogArchiveAccountId
          Regions:
            - !Ref AWS::Region
      TemplateURL: !Sub https://${pSRAStagingS3BucketName}.s3.${AWS::Region}.${AWS::URLSuffix}/${pSRASolutionName}/templates/sra-security-lake-org-configuration-role.yaml
      Parameters:
        - ParameterKey: pManagementAccountId
          ParameterValue: !Ref AWS::AccountId
      Tags:
        - Key: sra-solution
          Value: !Ref pSRASolutionName

  rSecurityLakeConfigurationStack:
    Type: AWS::CloudFormation::Stack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    DependsOn: rSecurityLakeConfigurationIAMRoleStackSet
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketName}.s3.${AWS::Region}.${AWS::URLSuffix}/${pSRASolutionName}/templates/sra-security-lake-org-configuration.yaml
      Parameters:
        pComplianceFrequency: !Ref pComplianceFrequency
        pControlTowerLifeCycleRuleName: !Ref pControlTowerLifeCycleRuleName
        pControlTowerRegionsOnly: !Ref pControlTowerRegionsOnly
        pCreateLambdaLogGroup: !Ref pCreateLambdaLogGroup
        pDelegatedAdminAccountId: !Ref pLogArchiveAccountId
        pEnabledRegions: !Ref pEnabledRegions
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pSRAAlarmEmail: !Ref pSRAAlarmEmail
        pSRAStagingS3BucketName: !Ref pSRAStagingS3BucketName
        pCreateOrganizationConfiguration: !Ref pCreateOrganizationConfiguration
        pOrgConfigurationSources: !Join
            - ','
            - !Ref pOrgConfigurationSources
        # pCreateKmsKey: !Ref pCreateKmsKey
        pCloudTrailManagementEvents: !Join
          - ','
          - !Ref pCloudTrailManagementEvents
        pCloudTrailLambdaDataEvents: !Join
          - ','
          - !Ref pCloudTrailLambdaDataEvents
        pCloudTrailS3DataEvents: !Join
          - ','
          - !Ref pCloudTrailS3DataEvents
        pSecurityHubFindings: !Join
          - ','
          - !Ref pSecurityHubFindings
        pVpcFlowLogs: !Join
          - ','
          - !Ref pVpcFlowLogs
        pWafLogs: !Join
          - ','
          - !Ref pWafLogs
        pRoute53Logs: !Join
          - ','
          - !Ref pRoute53Logs
        pEksAuditLogs: !Join
          - ','
          - !Ref pEksAuditLogs
        pSourceVersion: !Ref pSourceVersion
        pRegisterAuditAccountDataSubscriber: !Ref pRegisterAuditAccountDataSubscriber
        pRegisterAuditAccountQuerySubscriber: !Ref pRegisterAuditAccountQuerySubscriber
        pCreateQuerySubscriber: !Ref pCreateQuerySubscriber
        pCreateDataSubscriber: !Ref pCreateDataSubscriber
        pQuerySubscriberName: !Ref pQuerySubscriberName
        pDataSubscriberName: !Ref pDataSubscriberName
        pQuerySubscriberExternalId: !Ref pQuerySubscriberExternalId
        pDataSubscriberExternalId: !Ref pDataSubscriberExternalId
        pQuerySubscriberRegions: !Ref pQuerySubscriberRegions
        pDataSubscriberRegions: !Ref pDataSubscriberRegions
        pQuerySubscriberLogSources: !Join
            - ','
            - !Ref pQuerySubscriberLogSources
        pDataSubscriberLogSources: !Join
            - ','
            - !Ref pDataSubscriberLogSources
        pQuerySubscriberAccount: !Ref pQuerySubscriberAccount
        pDataSubscriberAccount: !Ref pDataSubscriberAccount
        pCreateDataSubscriberNotification: !Ref pCreateDataSubscriberNotification
        pOrganizationId: !Ref pOrganizationId
      Tags:
        - Key: sra-solution
          Value: !Ref pSRASolutionName

  # rSecurityLakeAuditSubscriberIAMRoleStackSet:
  #   Type: AWS::CloudFormation::StackSet
  #   Condition: cRegisterAuditAccountQuerySubscriber
  #   Properties:
  #     StackSetName: sra-security-lake-query-subscriber-role-2
  #     AdministrationRoleARN: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/${pStackSetAdminRole}
  #     CallAs: SELF
  #     Capabilities:
  #       - CAPABILITY_NAMED_IAM
  #     Description:
  #       !Sub ${pSRASolutionVersion} - Deploys an IAM role via ${pSRASolutionName} for configuring SecurityLake
  #     ExecutionRoleName: !Ref pStackExecutionRole
  #     ManagedExecution:
  #       Active: true
  #     OperationPreferences:
  #       FailureTolerancePercentage: 0
  #       MaxConcurrentPercentage: 100
  #       RegionConcurrencyType: PARALLEL
  #     PermissionModel: SELF_MANAGED
  #     StackInstancesGroup:
  #       - DeploymentTargets:
  #           Accounts:
  #             - !Ref pAuditAccountId
  #         Regions:
  #           - !Ref AWS::Region
  #     TemplateURL: !Sub https://${pSRAStagingS3BucketName}.s3.${AWS::Region}.${AWS::URLSuffix}/${pSRASolutionName}/templates/sra-security-lake-query-subscriber-role.yaml
  #     Parameters:
  #       - ParameterKey: pManagementAccountId
  #         ParameterValue: !Ref AWS::AccountId
  #     Tags:
  #       - Key: sra-solution
  #         Value: !Ref pSRASolutionName

  # rSecurityLakeConfigurationIAMRoleStack:
  #   Type: AWS::CloudFormation::Stack
  #   Properties:
  #     TemplateURL: !Sub https://${pSRAStagingS3BucketName}.s3.${AWS::Region}.${AWS::URLSuffix}/${pSRASolutionName}/templates/sra-security-lake-org-configuration-role.yaml
  #     Parameters:
  #       pManagementAccountId: !Ref AWS::AccountId
  #       pLogArchiveAccountId: !Ref pLogArchiveAccountId
  #     Tags:
  #       - Key: sra-solution
  #         Value: !Ref pSRASolutionName
  #   DeletionPolicy: Delete
  #   UpdateReplacePolicy: Delete
